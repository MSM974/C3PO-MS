import QUnit from 'qunit';
import { getLunchMenusForDate, filterMenus} from '../src/logic/menus.js'; 

QUnit.module('US-21 : Voir les menus');

QUnit.test('Renvoie uniquement les menus de type D√©jeuner pour une date donn√©e', assert => {
  const menus = [
    {
      date: "2025-07-14",
      menus: [
        { id: "menu-001", type: "D√©jeuner", name: "Poulet r√¥ti" },
        { id: "menu-002", type: "Petit d√©jeuner", name: "Croissant" },
        { id: "menu-003", type: "D√©jeuner", name: "Gratin dauphinois" }
      ]
    }
  ];

  const result = getLunchMenusForDate(menus, "2025-07-14");

  assert.equal(result.length, 2, "2 menus d√©jeuner doivent √™tre retourn√©s");
  assert.ok(result.find(m => m.name === "Poulet r√¥ti"), "Menu 'Poulet r√¥ti' trouv√©");
  assert.ok(result.find(m => m.name === "Gratin dauphinois"), "Menu 'Gratin dauphinois' trouv√©");
});


// TEST U22 ET U26
QUnit.module("US-22 ET U-26 - R√©servation d‚Äôun menu avec ANNULATION possible");

QUnit.test("Un seul menu r√©serv√© par jour", function (assert) {
  let reservations = {};

  const reserve = (dayKey, choice) => {
    if (reservations[dayKey] && reservations[dayKey] !== choice) return;
    reservations = {
      ...reservations,
      [dayKey]: reservations[dayKey] === choice ? null : choice,
    };
  };

  reserve("2025-07-15", "Choix 1");
  assert.equal(reservations["2025-07-15"], "Choix 1", "Menu Choix 1 r√©serv√©");

  reserve("2025-07-15", "Choix 2");
  assert.equal(reservations["2025-07-15"], "Choix 1", "Menu Choix 2 ignor√© car un autre choix est d√©j√† r√©serv√©");

  reserve("2025-07-15", "Choix 1");
  assert.equal(reservations["2025-07-15"], null, "Annulation du menu apr√®s second clic");
});

// TEST U27
QUnit.module("US-27 - Confirmation des r√©servations");

QUnit.test("Message de confirmation affich√©", function (assert) {
  const menusReserved = 2;
  const total = 12;
  const message = `Vous avez r√©serv√© ${menusReserved} menu(s). ‚úÖ\n üßæTotal : ${total.toFixed(2)} ‚Ç¨ üí∂\n\nSouhaitez-vous confirmer ces r√©servations ?`;

  assert.ok(message.includes("Souhaitez-vous confirmer"), "Le message contient une demande de confirmation");
});


// TEST FILTERMENU

QUnit.module("Recherche insensible √† la casse et aux accents");

QUnit.test("Trouver un plat m√™me si l'utilisateur tape sans accent ni majuscule", assert => {
  const jours = [
    { date: "2025-07-14", formattedDate: "Lundi 14 juillet 2025" }
  ];
  const menus = [
    {
      date: "2025-07-14",
      menus: [
        { id: "menu-001", entree: "Salade", plat: "Poulet r√¥ti", dessert: "Flan", type: "D√©jeuner", choice: "Choix 1" },
        { id: "menu-002", entree: "Salade Verte", plat: "Gratin dauphinois", dessert: "Tarte", type: "D√©jeuner", choice: "Choix 2" }
      ]
    }
  ];
  const exceptionalDays = {};

  // Test 1 : recherche "poulet"
  let filtered = filterMenus(jours, "poulet", menus, exceptionalDays);
  assert.equal(filtered.length, 1, "Le jour est trouv√© avec 'poulet'");

  // Test 2 : recherche "POULET" (majuscules)
  filtered = filterMenus(jours, "POULET", menus, exceptionalDays);
  assert.equal(filtered.length, 1, "Le jour est trouv√© avec 'POULET'");

  // Test 3 : recherche "p√¥√ªl√©t" (accents bizarres)
  filtered = filterMenus(jours, "p√¥√ªl√©t", menus, exceptionalDays);
  assert.equal(filtered.length, 1, "Le jour est trouv√© avec 'p√¥√ªl√©t'");

  // Test 4 : recherche "GRATIN" (autre plat)
  filtered = filterMenus(jours, "GRATIN", menus, exceptionalDays);
  assert.equal(filtered.length, 1, "Le jour est trouv√© avec 'GRATIN'");

  // Test 5 : recherche "tarte" (dessert)
  filtered = filterMenus(jours, "tarte", menus, exceptionalDays);
  assert.equal(filtered.length, 1, "Le jour est trouv√© avec 'tarte'");

  // Test 6 : recherche qui ne doit rien trouver
  filtered = filterMenus(jours, "lasagne", menus, exceptionalDays);
  assert.equal(filtered.length, 0, "Aucun jour trouv√© avec 'lasagne'");
});

